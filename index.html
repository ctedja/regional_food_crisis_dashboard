<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Build</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js"></script>
    <script src="https://kit.fontawesome.com/f3135b3376.js" crossorigin="anonymous"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet" />
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>

    <script>
        $(document).ready(function () {
            $('a[data-bs-toggle="tab"]').on("shown.bs.tab", function (e) {
                var activeTab = $(e.target).text(); // Get the name of active tab
                var previousTab = $(e.relatedTarget).text(); // Get the name of previous active tab
                $(".active-tab span").html(activeTab);
                $(".previous-tab span").html(previousTab);
            });
        });
    </script>
</head>


<body>

    <div class="m-4">
        <header>The Global Food Crisis: Asia-Pacific</header>
        <ul id="myTab" class="nav nav-tabs">
            <li class="nav-item">
                <a href="#mapTab" class="nav-link active mapTabButton" data-bs-toggle="tab">MAP</a>
            </li>
            <li class="nav-item">
                <a href="#tableTab" class="nav-link tableTabButton" data-bs-toggle="tab">TABLE</a>
            </li>
        </ul>

        <div class="tab-content">
            <br>

            <!-- Map Tab -->
            <div class="tab-pane fade show active" id="mapTab">

                <div class="sidebar">
                    <div class="select">
                        <select id="countrySelector" class="form-select selectpicker" data-width="100%" data-size="8"
                            name="country" data-dropdown>
                            <option value="">&#xf3c5;&nbsp;&nbsp;Country</option>
                            <option id="all" value="All">&nbsp;&nbsp;All</option>
                            <option id="afg" value="Afghanistan">&nbsp;&nbsp;Afghanistan</option>
                            <option value="Bangladesh">&nbsp;&nbsp;Bangladesh</option>
                            <option value="Bhutan">&nbsp;&nbsp;Bhutan</option>
                            <option value="India">&nbsp;&nbsp;India</option>
                        </select>
                    </div>
                    <br>
                    <div class="select">
                        <select id="indicatorSelector" class="form-select selectpicker" data-width="100%" data-size="8"
                            name="country" data-dropdown>
                            <option value="">&#xf3c5;&nbsp;&nbsp;SELECT INDICATOR</option>
                            <option value="Alert Status">&nbsp;&nbsp;Alert Status</option>
                            <option value="Underlying Food Insecurity">&nbsp;&nbsp;Underlying Food Insecurity</option>
                        </select>
                    </div>
                    <br>
                    <div id="narrativeTitle"></div>
                    <div id="narrativeText"></div>
                </div>
                <div id="map" class="map"></div>
            </div>image.png


            <!-- Table Tab -->
            <div class="tab-pane fade" id="tableTab">
                <h4 class="mt-2">Table tab content</h4>
                <p>Insert a table here.</p>
            </div>
        </div>
    </div>



    <script>
        const countryData = [
            ["AFG", "Afghanistan", "Test narrative about Afghanistan", "Alert Status", "Concern", 65, 34],
            ["BGD", "Bangladesh", "Test narrative about Bangladesh", "Alert Status", "Monitor", 90, 24],
            ["BTN", "Bhutan", "Test narrative about Bhutan", "Alert Status", "Concern", 90, 28],
            ["IND", "India", "Test narrative about India Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse ipsum augue, elementum at sodales quis, venenatis nec velit. Ut ut nunc est. Ut in lacus at augue imperdiet tempus. Pellentesque eleifend, lacus et sodales mattis, magna ex placerat nisi, nec cursus elit ligula at magna. Integer nec sem nec est mollis sagittis eu quis dui. Integer molestie tortor feugiat condimentum iaculis. Ut semper nisl vitae arcu porta, vel tristique lacus gravid Nam tempor, purus non eleifend vestibulum, urna leo aliquet diam, tempor faucibus orci neque id nulla. Ut pulvinar elit a posuere vehicula. Integer bibendum justo a tellus porta posuere. Vivamus aliquam vel nunc id accumsan. Etiam sed fermentum dolor. Quisque ac condimentum dui. Proin magna ipsum, vehicula tincidunt consequat in, pulvinar ac massa. Sed turpis elit, dapibus a malesuada rhoncus, tempor at metus. Vestibulum pellentesque, nisl nec sodales dictum, justo est fermentum tortor, quis scelerisque nisl urna vel ex. Maecenas efficitur felis eros, sit amet sollicitudin neque ultricies sit amet. Aenean sapien tellus, porta et rhoncus in, scelerisque volutpat lorem. Nulla vel libero nulla. Sed vulputate bibendum pretium. Phasellus eget leo a dolor eleifend sollicitudin",
                "Alert Status", "Concern", 79, 23],
            ["PAK", "Pakistan", "Test narrative about Pakistan", "Alert Status", "Concern", 68, 30],
            ["AFG", "Afghanistan", "Test narrative about Afghanistan", "Underlying Food Insecurity", "Concern", 65, 34],
            ["BGD", "Bangladesh", "Test narrative about Bangladesh", "Underlying Food Insecurity", "Monitor", 90, 24],
            ["BTN", "Bhutan", "Test narrative about Bhutan", "Underlying Food Insecurity", "Concern", 90, 28],
            ["IND", "India", "Test narrative about India Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse ipsum augue, elementum at sodales quis, venenatis nec velit. Ut ut nunc est. Ut in lacus at augue imperdiet tempus. Pellentesque eleifend, lacus et sodales mattis, magna ex placerat nisi, nec cursus elit ligula at magna. Integer nec sem nec est mollis sagittis eu quis dui. Integer molestie tortor feugiat condimentum iaculis. Ut semper nisl vitae arcu porta, vel tristique lacus gravid Nam tempor, purus non eleifend vestibulum, urna leo aliquet diam, tempor faucibus orci neque id nulla. Ut pulvinar elit a posuere vehicula. Integer bibendum justo a tellus porta posuere. Vivamus aliquam vel nunc id accumsan. Etiam sed fermentum dolor. Quisque ac condimentum dui. Proin magna ipsum, vehicula tincidunt consequat in, pulvinar ac massa. Sed turpis elit, dapibus a malesuada rhoncus, tempor at metus. Vestibulum pellentesque, nisl nec sodales dictum, justo est fermentum tortor, quis scelerisque nisl urna vel ex. Maecenas efficitur felis eros, sit amet sollicitudin neque ultricies sit amet. Aenean sapien tellus, porta et rhoncus in, scelerisque volutpat lorem. Nulla vel libero nulla. Sed vulputate bibendum pretium. Phasellus eget leo a dolor eleifend sollicitudin",
                "Underlying Food Insecurity", "Concern", 79, 23],
            ["PAK", "Pakistan", "Test narrative about Pakistan", "Underlying Food Insecurity", "Concern", 68, 30]
        ];
        console.log(countryData)

        const countrySelector = document.getElementById('countrySelector')
        const indicatorSelector = document.getElementById('indicatorSelector')


        let clickedItem = ''

        // First define the const match, then create the if actions
        countrySelector.addEventListener('change', function (e) {
            const match = countryData.filter(countryArr => countryArr[1] === this.value);
            console.log('You clicked a row containing the country of ' + this.value)
            console.log(match)
            //if (match) document.getElementById('narrativeTitle').innerHTML = match[1];
            //if (match) document.getElementById("narrativeText").innerHTML = match[2];
            displayNarrativeTitle(match);
            displayNarrativeText(match);
        });

        indicatorSelector.addEventListener('change', function (e) {
            const match = countryData.filter(countryArr => countryArr[3] === this.value);
            console.log('You clicked a row containing the indicator of ' + this.value)
            console.log(match)
            for (let i = 0; i < match.length; i++) {
                displayIndicator(match[2]);
            }
        });

        function displayNarrativeTitle(filteredRows) {
            if (filteredRows) document.getElementById("narrativeTitle").innerHTML = filteredRows[1];
        }

        function displayNarrativeText(filteredRows) {
            if (filteredRows) document.getElementById("narrativeText").innerHTML = filteredRows[2];
        }

        function displayIndicator(filteredRows) {
            if (filteredRows) document.getElementById("narrativeText").innerHTML = filteredRows[2];
        }



        // Load the map
        mapboxgl.accessToken = 'pk.eyJ1IjoiY3RlZGphIiwiYSI6ImNraWk4OGd6aTA0dGQyeW1pbWF2Mm5qbTUifQ.H7qbJAdh988Vg7mq8Muvjw';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/ctedja/ckxf77dtjg8nx15o5bn7st070',
            center: [100, 20],
            zoom: 2.5
        });


        map.on('load', function () {
            map.addSource('cbs', {  // country-boundaries-simplified
                'type': 'geojson',
                'data': 'https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_50m_admin_0_countries.geojson',
                'generateId': true
            });
        });

        let hoveredStateId = null;

        // Create the function to display the map
        function displayChloro(filteredRows) {

            for (let i = 0; i < filteredRows.length; i++) {

                map.removeLayer("countryFill" + [i]);
                map.removeLayer("countryBorder" + [i]);

                console.log("one of these filtered rows is " + filteredRows[i][4])

                let addColor;
                if (filteredRows[i][4] == "Concern") {
                    addColor = "#4da4d0";
                } else if (filteredRows[i][4] == "Monitor") {
                    addColor = "#8ac6ca";
                } else {
                    addColor = "#bbbbbb"
                };

                let filteredCountry = filteredRows[i][0]

                // Fader
                setTimeout(function () {
                    map.setPaintProperty("countryFill" + [i], "fill-opacity", .75);
                },
                    0
                );

                // country-fills
                map.addLayer({
                    "id": "countryFill" + [i],
                    "type": "fill",
                    "source": "cbs",
                    "layout": {},
                    "paint": {
                        "fill-color": addColor,
                        "fill-opacity": .25,
                        "fill-opacity-transition": { duration: 1000 }
                    },
                    "filter": ["==", "adm0_a3", filteredCountry]
                })

                // country borders
                map.addLayer({
                    "id": "countryBorder" + [i],
                    "type": "line",
                    "source": "cbs",
                    "layout": {},
                    "paint": {
                        "line-color": 'white',
                        "line-width": .9
                    },
                    "filter": ["==", "adm0_a3", filteredCountry]
                });

                const popup = new mapboxgl.Popup({
                    closeButton: false,
                    closeOnClick: false
                });



                // Popups
                map.on('mouseenter', 'countryFill' + [i], (e) => {

                    console.log('A mouseenter event occurred on ' + [i]);
                    map.getCanvas().style.cursor = 'pointer';

                    popup.setLngLat({ lng: filteredRows[i][5], lat: filteredRows[i][6] })
                        .setHTML('<h3>' + filteredRows[i][1] +
                            '</h3><h4><i class="fas fa-circle" style="color:' + addColor + '";></i>&nbsp;&nbsp;' +
                            filteredRows[i][3] + ': ' + filteredRows[i][4] + '</h4>')
                        .addTo(map);
                });

                map.on("mouseleave", "countryFill" + [i], () => {
                    popup.remove();
                    map.getCanvas().style.cursor = '';
                });





                // Hover effects
                map.addLayer({
                    "id": "hoverBorder" + [i],
                    "type": "fill",
                    "source": "cbs",
                    "layout": {},
                    "paint": {
                        "fill-color": addColor,
                        "fill-outline-color": "white",
                        "fill-opacity": [
                            'case',
                            ['boolean', ['feature-state', 'hover'], false],
                            1,
                            0
                        ]
                    },
                    "filter": ["==", "adm0_a3", filteredCountry]
                });

                map.on('mouseover', 'hoverBorder' + [i], (e) => {
                    if (e.features.length > 0) {
                        if (hoveredStateId !== null) {
                            map.setFeatureState(
                                { source: 'cbs', id: hoveredStateId },
                                { hover: false }
                            );
                        }
                        hoveredStateId = e.features[0].id;
                        map.setFeatureState(
                            { source: 'cbs', id: hoveredStateId },
                            { hover: true }
                        );
                    }
                });

                map.on("mouseleave", "hoverBorder" + [i], () => {
                    if (hoveredStateId !== null) {
                        map.setFeatureState(
                            { source: 'cbs', id: hoveredStateId },
                            { hover: false }
                        );
                    }
                    hoveredStateId = null;
                });




                // Event listeners for the map itself
                map.on("click", "countryFill" + [i], () => {
                    flyFunction(i)
                    document.getElementById("narrativeTitle").innerHTML = filteredRows[i][1]
                    document.getElementById("narrativeText").innerHTML = filteredRows[i][2]
                });


                function flyFunction() {
                    map.flyTo({
                        center: [filteredRows[i][5], filteredRows[i][6]],
                        zoom: 3.5,
                        speed: 0.4,
                        curve: 2
                    })
                };




                // const countryChloro = map.queryRenderedFeatures(event.point, {
                //     layers: ['statedata']
                // });

                // console.log(countryChloro)

                // // Change the cursor style as a UI indicator.
                // map.getCanvas().style.cursor = 'pointer';

                // // Copy coordinates array.
                // const coordinates = e.features[0].geometry.coordinates.slice();
                // const description = e.features[0].properties.description;

                // // Ensure that if the map is zoomed out such that multiple
                // // copies of the feature are visible, the popup appears
                // // over the copy being pointed to.
                // while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                //     coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                // }

                // // Populate the popup and set its coordinates
                // // based on the feature found.
                // popup.setLngLat(coordinates).setHTML(description).addTo(map);
                // });
            }
        }

        // Add the function 
        // countrySelector.addEventListener('change', function (e) {
        //     const match = countryData.filter(countryArr => countryArr[1] === this.value);
        //     displayChloro(match);
        // });

        indicatorSelector.addEventListener('change', function (e) {
            const match = countryData.filter(countryArr => countryArr[3] === this.value);
            displayChloro(match);
        });


        // Array.from(countrySelector).forEach(function (item) {
        //     item.addEventListener('click', function () {
        //         flyFunction(item.id);
        //         displayChloro(item.id)
        //     })
        // })

    </script>
</body>

</html>