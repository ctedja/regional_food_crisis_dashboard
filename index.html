<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Build</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js"></script>
    <script src="https://kit.fontawesome.com/f3135b3376.js" crossorigin="anonymous"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet" />
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>

    <script>
        $(document).ready(function () {
            $('a[data-bs-toggle="tab"]').on("shown.bs.tab", function (e) {
                var activeTab = $(e.target).text(); // Get the name of active tab
                var previousTab = $(e.relatedTarget).text(); // Get the name of previous active tab
                $(".active-tab span").html(activeTab);
                $(".previous-tab span").html(previousTab);
            });
        });
    </script>
</head>


<body>

    <div class="m-4">
        <header>Regional Food Crisis</header>
        <ul id="myTab" class="nav nav-tabs">
            <li class="nav-item">
                <a href="#mapTab" class="nav-link active" data-bs-toggle="tab">Home</a>
            </li>
            <li class="nav-item">
                <a href="#tableTab" class="nav-link" data-bs-toggle="tab">Profile</a>
            </li>
        </ul>

        <div class="tab-content">
            <br>

            <!-- Map Tab -->
            <div class="tab-pane fade show active" id="mapTab">

                <div class="sidebar">
                    <div class="select">
                        <select id="countrySelector" class="form-select selectpicker" data-width="100%" data-size="8"
                            name="country" data-dropdown>
                            <option value="">&#xf3c5;&nbsp;&nbsp;Country</option>
                            <option id="all" value="All">&nbsp;&nbsp;All</option>
                            <option id="afg" value="Afghanistan">&nbsp;&nbsp;Afghanistan</option>
                            <option value="Bangladesh">&nbsp;&nbsp;Bangladesh</option>
                            <option value="Bhutan">&nbsp;&nbsp;Bhutan</option>
                            <option value="India">&nbsp;&nbsp;India</option>
                        </select>
                    </div>
                    <div class="select">
                        <select id="indicatorSelector" class="form-select selectpicker" data-width="100%" data-size="8"
                            name="country" data-dropdown>
                            <option value="">&#xf3c5;&nbsp;&nbsp;Indicator</option>
                            <option value="Status">&nbsp;&nbsp;Status</option>
                            <option value="GDP">&nbsp;&nbsp;GDP</option>
                        </select>
                    </div>
                    <br>
                    <div id="narrativeTitle"></div>
                    <div id="narrativeText"></div>
                </div>
                <div id="map" class="map"></div>
            </div>


            <!-- Table Tab -->
            <div class="tab-pane fade" id="tableTab">
                <h4 class="mt-2">Profile tab content</h4>
                <p>Insert a table here.</p>
            </div>
        </div>
    </div>



    <script>
        const countryData = [
            ["AFG", "Afghanistan", "Test narrative about Afghanistan", "Status", "Concern"],
            ["BGD", "Bangladesh", "Test narrative about Bangladesh", "Status", "Monitor"],
            ["BTN", "Bhutan", "Test narrative about Bhutan", "Status", "Concern"],
            ["IND", "India", "Test narrative about India Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse ipsum augue, elementum at sodales quis, venenatis nec velit. Ut ut nunc est. Ut in lacus at augue imperdiet tempus. Pellentesque eleifend, lacus et sodales mattis, magna ex placerat nisi, nec cursus elit ligula at magna. Integer nec sem nec est mollis sagittis eu quis dui. Integer molestie tortor feugiat condimentum iaculis. Ut semper nisl vitae arcu porta, vel tristique lacus gravid Nam tempor, purus non eleifend vestibulum, urna leo aliquet diam, tempor faucibus orci neque id nulla. Ut pulvinar elit a posuere vehicula. Integer bibendum justo a tellus porta posuere. Vivamus aliquam vel nunc id accumsan. Etiam sed fermentum dolor. Quisque ac condimentum dui. Proin magna ipsum, vehicula tincidunt consequat in, pulvinar ac massa. Sed turpis elit, dapibus a malesuada rhoncus, tempor at metus. Vestibulum pellentesque, nisl nec sodales dictum, justo est fermentum tortor, quis scelerisque nisl urna vel ex. Maecenas efficitur felis eros, sit amet sollicitudin neque ultricies sit amet. Aenean sapien tellus, porta et rhoncus in, scelerisque volutpat lorem. Nulla vel libero nulla. Sed vulputate bibendum pretium. Phasellus eget leo a dolor eleifend sollicitudin",
                "Status", "Concern"],
            ["AFG", "Afghanistan", "Test narrative about Afghanistan", "GDP", "Monitor"],
            ["BGD", "Bangladesh", "Test narrative about Bangladesh", "GDP", "Monitor"],
            ["BTN", "Bhutan", "Test narrative about Bhutan", "GDP", "Concern"],
            ["IND", "India", "Test narrative about India",
                "GDP", "Monitor"]
        ];
        console.log(countryData)

        const countrySelector = document.getElementById('countrySelector')
        const indicatorSelector = document.getElementById('indicatorSelector')


        let clickedItem = ''

        // First define the const match, then create the if actions
        countrySelector.addEventListener('change', function (e) {
            const match = countryData.filter(countryArr => countryArr[1] === this.value);
            console.log('You clicked a row containing the country of ' + this.value)
            console.log(match)
            //if (match) document.getElementById('narrativeTitle').innerHTML = match[1];
            //if (match) document.getElementById("narrativeText").innerHTML = match[2];
            displayNarrativeTitle(match);
            displayNarrativeText(match);
        });

        // indicatorSelector.addEventListener('change', function (e) {
        //     const match = countryData.filter(countryArr => countryArr[3] === this.value);
        //     console.log('You clicked a row containing the indicator of ' + this.value)
        //     console.log(match)
        //     //if (match) document.getElementById('narrativeTitle').innerHTML = match[1];
        //     //if (match) document.getElementById("narrativeText").innerHTML = match[2];
        //     displayNarrativeTitle(match);
        //     displayNarrativeText(match);
        // });

        function displayNarrativeTitle(filteredRow) {
            if (filteredRow) document.getElementById("narrativeTitle").innerHTML = filteredRow[1];
        }

        function displayNarrativeText(filteredRow) {
            if (filteredRow) document.getElementById("narrativeText").innerHTML = filteredRow[2];
        }






        // Mapping
        mapboxgl.accessToken = 'pk.eyJ1IjoiY3RlZGphIiwiYSI6ImNraWk4OGd6aTA0dGQyeW1pbWF2Mm5qbTUifQ.H7qbJAdh988Vg7mq8Muvjw';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/ctedja/ckxf77dtjg8nx15o5bn7st070',
            center: [80, 20],
            zoom: 1.5
        });

        map.on('load', function () {
            map.addSource('cbs', {  // country-boundaries-simplified
                'type': 'geojson',
                'data': 'https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_50m_admin_0_countries.geojson'
            });
        });

        // Create a function 
        function displayChloro(filteredRow) {

            map.removeLayer("cf");
            map.removeLayer("cb");

            for (let i = 0; i < filteredRow.length; i++) {

                console.log("one of these filtered rows is " + filteredRow[i][4])


                let addColor;
                if (filteredRow[i][4] == "Concern") {
                    addColor = "#982b56";
                } else if (filteredRow[i][4] == "Monitor") {
                    addColor = "#f47847";
                } else {
                    addColor = "#007dbc"
                };

                let countryLabel = filteredRow[1]

                // country-fills
                map.addLayer({
                    "id": "cf",
                    "type": "fill",
                    "source": "cbs",
                    "layout": {},
                    "paint": {
                        "fill-color": addColor,
                        "fill-opacity": 0.1,
                    },
                    "filter": ["==", "adm0_a3", filteredRow[i][0]]
                })

                // country borders
                map.addLayer({
                    "id": "cb",
                    "type": "line",
                    "source": "cbs",
                    "layout": {},
                    "paint": {
                        "line-color": addColor,
                        "line-width": .5
                    },
                    "filter": ["==", "adm0_a3", filteredRow[i][0]]
                });
            }
        }

        // Add the function 
        countrySelector.addEventListener('change', function (e) {
            const match = countryData.filter(countryArr => countryArr[1] === this.value);
            displayChloro(match);
        });

        indicatorSelector.addEventListener('change', function (e) {
            const match = countryData.filter(countryArr => countryArr[3] === this.value);
            displayChloro(match);
        });


        // Array.from(countrySelector).forEach(function (item) {
        //     item.addEventListener('click', function () {
        //         flyFunction(item.id);
        //         displayChloro(item.id)
        //     })
        // })

    </script>
</body>

</html>