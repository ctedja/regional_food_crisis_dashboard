<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>RBB Food Crisis Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js"></script>
    <script src="https://kit.fontawesome.com/f3135b3376.js" crossorigin="anonymous"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet" />
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>
    <!-- Datatables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>


    <script>
        $(document).ready(function () {
            $('a[data-bs-toggle="tab"]').on("shown.bs.tab", function (e) {
                var activeTab = $(e.target).text(); // Get the name of active tab
                var previousTab = $(e.relatedTarget).text(); // Get the name of previous active tab
                $(".active-tab span").html(activeTab);
                $(".previous-tab span").html(previousTab);
            });
        });
    </script>
</head>

<body>

    <div class="m-4">
        <img id="logo" src="logo.png">
        <div style="
        display:inline-block;">
            <header>The Impact of the Global Food Crisis</header>
            <p id="subheader">AN OVERVIEW OF INDIVIDUAL COUNTRY-LEVEL IMPACTS</p>
        </div>
        <ul id="myTab" class="nav nav-tabs">
            <li class="nav-item">
                <a href="#mapTab" class="nav-link active mapTabButton" data-bs-toggle="tab">MAP</a>
            </li>
            <li class="nav-item">
                <a href="#tableTab" class="nav-link tableTabButton" data-bs-toggle="tab">TABLE</a>
            </li>
        </ul>

        <div class="tab-content">
            <br>

            <!-- Map Tab -->
            <div class="tab-pane fade show active" id="mapTab">

                <div class="sidebar">
                    <div class="select">
                        <p class="indicatorName">&nbsp;&#xf002;&nbsp;&nbsp;Search by Indicator or Country</p>
                        <select id="countrySelector" class="form-select selectpicker" data-width="100%" data-size="8"
                            name="country" data-dropdown>
                            <option value="">SELECT COUNTRY</option>
                            <option id="afg" value="AFG">Afghanistan</option>
                            <option value="BGD">Bangladesh</option>
                            <option value="BTN">Bhutan</option>
                            <option value="KHM">Cambodia</option>
                            <option value="PRK">DPRK</option>
                            <option value="IND">India</option>
                            <option value="IDN">Indonesia</option>
                            <option value="KGZ">Kyrgyz Republic</option>
                            <option value="LAO">Laos</option>
                            <option value="MMR">Myanmar</option>
                            <option value="NPL">Nepal</option>
                            <option value="FJI">Pacific</option>
                            <option value="PAK">Pakistan</option>
                            <option value="PHL">Philippines</option>
                            <option value="LKA">Sri Lanka</option>
                            <option value="TAJ">Tajikistan</option>
                            <option value="TLS">Timor-Leste</option>
                        </select>
                    </div>
                    <div class="select">
                        <select id="indicatorSelector" class="form-select selectpicker" data-width="100%" data-size="8"
                            name="country" data-dropdown>
                            <option value="">SELECT INDICATOR</option>
                            <option value="Overall Vulnerability">Overall Vulnerability</option>
                            <option value="Underlying Food Insecurity">Underlying Food Insecurity</option>
                            <option value="Inflation (%)">Inflation (%)</option>
                            <option value="Food Inflation (%)">Food Inflation (%)</option>
                            <option value="Currency Exchange (YoY, %)">Currency Exchange (YoY)</option>
                            <!-- <option value="Dependency on Russia or Ukraine">Dependency on Russia or Ukraine
                            </option>
                            <option value="Cereal Import Dependency">Cereal Import Dependency</option>
                            <option value="Fertilizer Consumption">Fertilizer Consumption</option>
                            <option value="GDP">GDP</option> -->
                        </select>
                    </div>
                </div>
                <div id="narrativeBox">
                    <div id="narrativeTitle"></div>
                    <div id="narrativeText"></div>
                </div>
                <div id="map" class="map"></div>
                <div id="legend"></div>
                <div id="research"></div>
            </div>


            <!-- Table Tab -->
            <div class="tab-pane fade" id="tableTab">
                <div id="tableWrapper">
                    <table class="display" id="mydatatable">
                        <thead>
                            <tr>
                                <th>Country</th>
                                <th>Overall Vulnerability</th>
                                <th>Underlying Food Insecurity</th>
                                <th>Russia/Ukraine Dependency</th>
                                <th>Cereal Import Dependency (%)</th>
                                <th>Fertilizer Consumption</th>
                                <th>Debt Distress</th>
                                <th>GDP</th>
                                <th>Inflation (%)</th>
                                <th>Food Inflation (%)</th>
                                <th>Currency Exchange (%)</th>
                            </tr>
                        </thead>
                        <tbody id="myTable">
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Data
        const url_1 = 'https://raw.githubusercontent.com/ctedja/regional_food_crisis_dashboard/main/data2.json';
        const url_2 = 'https://raw.githubusercontent.com/ctedja/regional_food_crisis_dashboard/main/dataIndicators.json';

        async function populate() {
            const response = await fetch(url_1);
            const countryData = await response.json();

            const response2 = await fetch(url_2);
            const indicatorData = await response2.json();


            console.log(countryData)
            // Proceed
            const countrySelector = document.getElementById('countrySelector')
            const indicatorSelector = document.getElementById('indicatorSelector')
            let clickedItem = ''

            // Use the selectors to filter and fly
            countrySelector.addEventListener('change', function (e) {
                const match = countryData.filter(countryArr => countryArr[0] === this.value);
                console.log('You clicked a row containing the country of ' + this.value)
                console.log('You clicked a match for the country of ' + match[1][0])
                document.getElementById("narrativeTitle").innerHTML = match[1][1];
                // document.getElementById("narrativeText").innerHTML = match[1][2];
                displayNarrative(match[1][2]);
                displayResearch(match[1][1], match[1][5], match[1][6], match[1][7], match[1][8], match[1][9], match[1][10], match[1][11], match[1][12], match[1][13]);
                displayChloroSingle(match[1][0])
                // Each argument corresponds to: displayResearch(marketAssessment, marketLink, fng, fngLink, primaryHighlight, primaryHighlightLink, secondaryHighlight, secondaryHighlightLink, upcoming)

                map.flyTo({
                    center: [match[1][17], match[1][18]],
                    zoom: match[1][19],
                    speed: 0.4,
                    curve: 2
                })

            });

            indicatorSelector.addEventListener('change', function (e) {
                const match = countryData.filter(countryArr => countryArr[20] === this.value);
                console.log('You clicked a row containing the indicator of ' + this.value)
                displayChloro(match);
                displayChloroSingle(match);
            });

            // Load the map
            mapboxgl.accessToken = 'pk.eyJ1IjoiY3RlZGphIiwiYSI6ImNraWk4OGd6aTA0dGQyeW1pbWF2Mm5qbTUifQ.H7qbJAdh988Vg7mq8Muvjw';
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/ctedja/ckxf77dtjg8nx15o5bn7st070',
                center: [105, 20],
                zoom: 2.25
            });


            map.on('load', function () {
                map.addSource('cbs', {  // country-boundaries-simplified
                    'type': 'geojson',
                    'data': 'https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_50m_admin_0_countries.geojson',
                    'generateId': true
                });
                // Create a default layer
                const defaultLayer = countryData.filter(countryArr => countryArr[20] === 'Overall Vulnerability')
                displayChloro(defaultLayer)
            });


            let hoveredStateId = null;

            // FUNCTIONS
            // Create the function to change the research box 
            function displayResearch(countryName, marketAssessment, marketLink, fng, fngLink, primaryHighlight, primaryHighlightLink, secondaryHighlight, secondaryHighlightLink, upcoming) {
                // marketAssessment, marketLink, fng, fngLink, primaryHighlight, primaryHighlightLink, secondaryHighlight, secondaryHighlightLink, upcoming
                let primaryText;
                if (primaryHighlight == null) {
                    primaryText = "";
                } else {
                    primaryText = "<i class='fa-solid fa-magnifying-glass-chart' style='font-size:14px'></i><br>" +
                        "<span style='font-weight:700'>" + primaryHighlight + "</span><br>" +
                        "LATEST  |  <a href='" + primaryHighlightLink + "' target='_blank'>LINK</a><br><br>"
                };

                let secondaryText;
                if (secondaryHighlight == null) {
                    secondaryText = "";
                } else {
                    secondaryText = "<i class='fa-solid fa-newspaper' style='font-size:14px'></i><br>" +
                        "<span style='font-weight:700'>" + secondaryHighlight + "</span><br>" +
                        "LATEST  |  <a href='" + secondaryHighlightLink + "' target='_blank'>LINK</a><br><br>"
                };

                let marketText;
                if (marketAssessment == null) {
                    marketText = "";
                } else {
                    marketText = "<i class='fa-solid fa-shop' style='font-size:14px'></i><br>" +
                        "<span style='font-weight:700'>MARKET MONITOR</span><br>" +
                        marketAssessment + "  |  <a href='" + marketLink + "' target='_blank'>LINK</a><br><br>"
                };

                let fngText;
                if (fng == null) {
                    fngText = "";
                } else {
                    fngText = "<i class='fa-solid fa-bowl-food' style='font-size:14px'></i><br>" +
                        "<span style='font-weight:700'>FILL THE NUTRIENT GAP</span><br>" +
                        fng + "  |  <a href='" + fngLink + "' target='_blank'>LINK</a><br><br>"
                };

                let upcomingText;
                if (upcoming == null) {
                    upcomingText = "";
                } else {
                    upcomingText = "<hr><br><i class='fas fa-step-forward' style='font-size:14px'></i><br>" +
                        "<span style='font-weight:700'>UPCOMING</span><br>" +
                        upcoming
                };

                document.getElementById("research").innerHTML =
                    "<span style='font-size:12px;color:#007dbc;font-weight:700'>Evidence: " + countryName + "</span>" + "<br>" + "<br>" +
                    // primaryText + secondaryText + 
                    primaryText + marketText + fngText + secondaryText + upcomingText
                //  + fngText + upcomingText
            }


            // Function to display narrative
            function displayNarrative(fsnNarrative
                // , wfpNarrative, stakeholderNarrative
            ) {
                let fsnText;
                if (fsnNarrative == "") {
                    fsnText = "";
                } else {
                    fsnText =
                        // "<span style='font-weight:700'>Food Security and Nutrition Implications: </span>" +
                        fsnNarrative
                    // + "<br><br>"
                };

                // let wfpText;
                // if (wfpNarrative == "") {
                //     wfpText = "";
                // } else {
                //     wfpText = "<span style='font-weight:700'>WFP Implications: </span>" +
                //         wfpNarrative + "<br><br>"
                // };

                // let stakeholderText;
                // if (stakeholderNarrative == "") {
                //     stakeholderText = "";
                // } else {
                //     stakeholderText = "<span style='font-weight:700'>Gov/Other Stakeholders: </span>" +
                //         stakeholderNarrative
                // };

                document.getElementById("narrativeText").innerHTML = fsnText
                //  + wfpText + stakeholderText
            }


            // Create the function to change text in the form-select
            function changeText(indicator) {
                document.getElementById("countrySelector").value = indicator;;
            }

            // Create the map display function. Use the 'for' to add the value for each individual country.
            function displayChloro(filteredRows) {

                for (let i = 0; i < filteredRows.length; i++) {

                    // Remove the layer if it exists, so that each time it can refresh anew.
                    if (map.getLayer("countryFill" + [i])) {
                        map.removeLayer("countryFill" + [i]);
                    }

                    if (map.getLayer("countryBorder" + [i])) {
                        map.removeLayer("countryBorder" + [i]);
                    }

                    if (map.getLayer("hoverFill" + [i])) {
                        map.removeLayer("hoverFill" + [i]);
                    }


                    let addColor;
                    if (filteredRows[i][22] == 1) {
                        addColor = "#2c575a";
                    } else if (filteredRows[i][22] == 2) {
                        addColor = "#58adb3";
                    } else if (filteredRows[i][22] == 3) {
                        addColor = "#acd6d9";
                    } else {
                        addColor = "#bbbbbb"
                    };

                    let filteredCountry = filteredRows[i][0]

                    // Fader
                    setTimeout(function () {
                        map.setPaintProperty("countryFill" + [i], "fill-opacity", 0.7);
                    },
                        0
                    );

                    // country-fills
                    map.addLayer({
                        "id": "countryFill" + [i],
                        "type": "fill",
                        "source": "cbs",
                        "layout": {},
                        "paint": {
                            "fill-color": addColor,
                            "fill-opacity": .25,
                            "fill-opacity-transition": { duration: 1000 }
                        },
                        "filter": ["==", "adm0_a3", filteredCountry]
                    })

                    // country borders
                    map.addLayer({
                        "id": "countryBorder" + [i],
                        "type": "line",
                        "source": "cbs",
                        "layout": {},
                        "paint": {
                            "line-color": 'white',
                            "line-width": .9
                        },
                        "filter": ["==", "adm0_a3", filteredCountry]
                    });



                    // Popups
                    const popup = new mapboxgl.Popup({
                        closeButton: false,
                        closeOnClick: false
                    });

                    map.on('mouseenter', 'countryFill' + [i], (e) => {
                        // console.log('A mouseenter event occurred on ' + [i]);
                        map.getCanvas().style.cursor = 'pointer';

                        let popupValueText;
                        if (filteredRows[i][21] == null) {
                            popupValueText = "Value not available"
                        } else {
                            popupValueText = filteredRows[i][21]
                        }


                        popup.setLngLat({ lng: filteredRows[i][17], lat: filteredRows[i][18] })
                            .setHTML('<h3><span style="color:' + addColor + '";>' + filteredRows[i][1] + "</span></h3><br><h4>"+
                                '<i class="fas fa-circle" style="color:' + addColor + '";></i>&nbsp;&nbsp;'
                                + popupValueText + '</h4><h5>' + filteredRows[i][20] + '' + '</h5>')
                            .addTo(map);
                    });

                    map.on("mouseleave", "countryFill" + [i], () => {
                        popup.remove();
                        map.getCanvas().style.cursor = '';
                    });



                    // Hover effects
                    map.addLayer({
                        "id": "hoverFill" + [i],
                        "type": "fill",
                        "source": "cbs",
                        "layout": {},
                        "paint": {
                            "fill-color": addColor,
                            "fill-outline-color": "white",
                            "fill-opacity": [
                                'case',
                                ['boolean', ['feature-state', 'hover'], false],
                                1,
                                0
                            ]
                        },
                        "filter": ["==", "adm0_a3", filteredCountry]
                    });

                    map.on('mouseover', 'hoverFill' + [i], (e) => {
                        if (e.features.length > 0) {
                            if (hoveredStateId !== null) {
                                map.setFeatureState(
                                    { source: 'cbs', id: hoveredStateId },
                                    { hover: false }
                                );
                            }
                            hoveredStateId = e.features[0].id;
                            map.setFeatureState(
                                { source: 'cbs', id: hoveredStateId },
                                { hover: true }
                            );
                        }
                    });

                    map.on("mouseleave", "hoverFill" + [i], () => {
                        if (hoveredStateId !== null) {
                            map.setFeatureState(
                                { source: 'cbs', id: hoveredStateId },
                                { hover: false }
                            );
                        }
                        hoveredStateId = null;
                    });

                    // Event listeners for the map itself
                    map.on("click", "countryFill" + [i], () => {
                        flyFunction(i);
                        document.getElementById("narrativeTitle").innerHTML = filteredRows[i][1];
                        displayNarrative(filteredRows[i][2], filteredRows[i][3], filteredRows[i][4]);
                        changeText(filteredRows[i][0]);
                        displayChloroSingle(filteredRows[i][0]);
                        displayResearch(filteredRows[i][1], filteredRows[i][5], filteredRows[i][6], filteredRows[i][7], filteredRows[i][8], filteredRows[i][9], filteredRows[i][10], filteredRows[i][11], filteredRows[i][12], filteredRows[i][13])
                    });


                    function flyFunction() {
                        map.flyTo({
                            center: [filteredRows[i][17], filteredRows[i][18]],
                            zoom: filteredRows[i][19],
                            speed: 0.4,
                            curve: 2
                        })
                    };
                }



                // Create legend
                var filteredIndicator = filteredRows[1][20]
                console.log('you look for : ' + filteredIndicator)

                var layers;
                if (filteredIndicator == "Overall Vulnerability")
                    layers = ["Country of Concern",
                        "Country to Monitor",
                        "NA"];
                else if (filteredIndicator == "Underlying Food Insecurity" |
                    filteredIndicator == "GDP" |
                    filteredIndicator == "Debt Distress" |
                    filteredIndicator == "Fertilizer Consumption" |
                    filteredIndicator == "Cereal Import Dependency" |
                    filteredIndicator == "Dependency on Russia or Ukraine")
                    layers = ["High",
                        "Moderate",
                        "Low"];
                else {
                    layers = [">=30%",
                        "10-30%",
                        "<=10%"]
                }

                const colors = [
                    '#2c575a', '#58adb3', '#acd6d9'
                ];

                legend.innerHTML = "";
                legend.innerHTML = ("<span style='font-size:20px;color:#007dbc'>" + filteredIndicator + "<br><br>");

                layers.forEach((layer, i) => {
                    const color = colors[i];
                    const item = document.createElement('div');
                    const key = document.createElement('span');
                    key.className = 'legend-key';
                    key.style.backgroundColor = color;

                    const value = document.createElement('span');
                    value.innerHTML = `${layer}`;
                    item.appendChild(key);
                    item.appendChild(value);
                    legend.appendChild(item);
                });
            }






            function displayChloroSingle(filteredCountry) {


                // Remove the layer if it exists, so that each time it can refresh anew.

                if (map.getLayer("countryBorder")) {
                    map.removeLayer("countryBorder");
                }


                // let filteredCountry = filteredRows[i][0]

                // // Fader
                // setTimeout(function () {
                //     map.setPaintProperty("countryFill", "fill-opacity", 0.7);
                // },
                //     0
                // );

                // country-fills
                // map.addLayer({
                //     "id": "countryFill",
                //     "type": "fill",
                //     "source": "cbs",
                //     "layout": {},
                //     "paint": {
                //         "fill-color": addColor,
                //         "fill-opacity": 1,
                //         "fill-opacity-transition": { duration: 1000 }
                //     },
                //     "filter": ["==", "adm0_a3", filteredCountry]
                // })

                // country borders
                map.addLayer({
                    "id": "countryBorder",
                    "type": "line",
                    "source": "cbs",
                    "layout": {},
                    "paint": {
                        "line-color": '#3b3b3b',
                        "line-width": 2
                    },
                    "filter": ["==", "adm0_a3", filteredCountry]
                });

            }



            // TABLE BUILDING
            function buildTable(data) {
                var table = document.getElementById('myTable')
                table.innerHTML = data.map(function (row) {
                    let [id, country, inflation, foodInflation, currencyExchange, russiaUkraineDependency, cerealImportDependency, fertilizerConsumption, debtDistress, gdp, underlyingFoodInsecurity, overallVulnerability] = row;
                    return `<tr>
                <td>${country}</td>
                <td>${overallVulnerability}</td>
                <td>${underlyingFoodInsecurity}</td>
                <td>${russiaUkraineDependency}</td>
                <td>${cerealImportDependency}</td>
                <td>${fertilizerConsumption}</td>
                <td>${debtDistress}</td>
                <td>${gdp}</td>
                <td>${inflation}</td>
                <td>${foodInflation}</td>
                <td>${currencyExchange}</td>
                </tr>`;
                }).join('');
            }

            buildTable(indicatorData)

            $("#mydatatable td").each(function () {
                if (this.textContent === "null")
                    this.textContent = "-"
            })

            $(document).ready(function () {
                $('#mydatatable').DataTable({
                    order: [[0, 'asc']],
                    stripeClasses: [],
                    // scrollY: '600px',
                    // scrollCollapse: true,
                    info: false,
                    paging: false,
                    searching: false,
                    columnDefs: [{
                        targets: [8, 9, 10],
                        className: 'dt-body-right',
                    },
                    {
                        targets: [8, 9, 10],
                        className: 'dt-head-right'
                    }],
                    aoColumns: [
                        null,
                        null,
                        { orderSequence: ['asc'] },
                        { orderSequence: ['desc', 'asc', 'asc'] },
                        { orderSequence: ['desc'] },
                        null
                    ],

                });
            });
        }
        populate();

    </script>
</body>

</html>